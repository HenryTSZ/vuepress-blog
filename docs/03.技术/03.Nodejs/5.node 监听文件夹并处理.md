---
title: node ç›‘å¬æ–‡ä»¶å¤¹å¹¶å¤„ç†
date: 2021-08-17 00:00:00
categories:
  - FrontEnd
  - Js
tags:
  - node
permalink: /pages/9cef33/
---

å½“æˆ‘ä»¬é•¿æ—¶é—´å‘æ–‡ä»¶å¤¹ä¸­æ·»åŠ å¤§é‡æ–‡ä»¶æ—¶, æ–‡ä»¶å‘½åæ˜¯ä¸€ä¸ªéå¸¸è€—æ—¶é—´çš„é—®é¢˜

<!-- more -->

æƒ³è±¡ä¸€ä¸‹: æˆ‘ä»¬ä» 001 å¼€å§‹å‘½å, æ¯æ¬¡æ·»åŠ è¿›ä¸€ä¸ªæ–‡ä»¶, éƒ½éœ€è¦ç»å†å…ˆçœ‹å½“å‰æ’åˆ°ç¬¬å‡ äº†, å†é‡å‘½å, è€Œä¸”æ²¡æœ‰å°é”®ç›˜è¾“å…¥æ•°å­—ä¹Ÿå¾ˆéº»çƒ¦

æ‰€ä»¥æˆ‘ä»¬éœ€è¦åšä¸€ä¸ªè‡ªåŠ¨é‡å‘½åçš„å·¥å…·

## fs.watch

é€šè¿‡ç®€å•çš„è®¡ç®—æœºçŸ¥è¯†æ‰¾åˆ°äº†è¿™ä¸ªæ–¹æ³•: [nodejs ç›‘å¬ç›®å½•, é‡å‘½åæ–‡ä»¶-å°æœ±çš„ä¸“æ -CSDN åšå®¢](https://blog.csdn.net/w20101310/article/details/107165946)

[fs æ–‡ä»¶ç³»ç»Ÿ | Node.js API æ–‡æ¡£](http://nodejs.cn/api/fs.html#fs_fs_watch_filename_options_listener)

```js
const fs = require('fs')

// åªç›‘å¬å½“å‰ç›®å½•
fs.watch('.', (event, fileName) => {
  console.log('ğŸš€ ~ file: index.js ~ line 4 ~ fs.watch ~ event, fileName', event, fileName)
  if (event === 'rename') {
    if (fs.existsSync(fileName)) {
      fs.rename(fileName, 'a1.js', err => {
        if (err) console.log('é‡å‘½åå¤±è´¥', err)
      })
    } else {
      console.log('æ–‡ä»¶è¢«åˆ é™¤')
    }
  }
})
```

```js
const fs = require('fs')
const path = require('path')

// é€’å½’ç›‘å¬æ‰€æœ‰ç›®å½•
fs.watch('.', { recursive: true }, (event, fileName) => {
  console.log('ğŸš€ ~ file: index.js ~ line 4 ~ fs.watch ~ event, fileName', event, fileName)
  if (event === 'rename') {
    if (fs.existsSync(fileName)) {
      const dirname = path.dirname(fileName)
      fs.rename(fileName, path.join(dirname, 'a1.js'), err => {
        if (err) console.log('é‡å‘½åå¤±è´¥', err)
      })
    } else {
      console.log('æ–‡ä»¶è¢«åˆ é™¤')
    }
  }
})
```

ä½†å®é™…æµ‹è¯•å‘ç° `fs.watch` çš„ `event` å¤§éƒ¨åˆ†éƒ½æ˜¯ `rename` , ä¸è®ºæ˜¯æ–°å¢åˆ é™¤é‡å‘½å, è¿™æ ·è‚¯å®šæ˜¯ä¸è¡Œçš„

å…¶å®å®˜ç½‘ä¹Ÿè¯´è¿‡è¿™ä¸ªé—®é¢˜:

> åœ¨å¤§å¤šæ•°å¹³å°ä¸Šï¼Œåªè¦ç›®å½•ä¸­æ–‡ä»¶åå‡ºç°æˆ–æ¶ˆå¤±ï¼Œå°±ä¼šè§¦å‘ 'rename'ã€‚

## chokidar

å†ç”¨è®¡ç®—æœºé«˜çº§çŸ¥è¯†æ‰¾åˆ°äº†è¿™ä¸ª: [paulmillr/chokidar: Minimal and efficient cross-platform file watching library](https://github.com/paulmillr/chokidar)

ä¸€æ¬¾ç›‘å¬æ–‡ä»¶å¤¹å†…å®¹å˜åŒ–çš„å·¥å…·

ç®€å•ä½¿ç”¨ä¾‹å­:

Install with npm:

```bash
npm install chokidar
```

Then require and use it in your code:

```js
const chokidar = require('chokidar')

// One-liner for current directory
chokidar.watch('.').on('all', (event, path) => {
  console.log(event, path)
})
```

## ä»¥ä¸‹ä¸ºæˆæœ

```js
const path = require('path')
const fs = require('fs')
const chokidar = require('chokidar')

const cwd = path.join(__dirname, 'img')
const readDir = fs.readdirSync(cwd)
let len = readDir.length

/**
 * watch(paths, [options])
 * ignoreInitial (default: false). If set to false then add/addDir events are also emitted for matching paths while instantiating the watching as chokidar discovers these file paths (before the ready event).
 * ç®€å•ç†è§£å°±æ˜¯å¯¹äºå·²æœ‰æ–‡ä»¶/æ–‡ä»¶å¤¹, åˆå§‹åŒ–çš„æ—¶å€™ä¹Ÿä¼šè§¦å‘ add/addDir äº‹ä»¶
 * æˆ‘ä»¬ç›®å‰åªéœ€è¦ç›‘å¬æ–°å¢çš„æ–‡ä»¶, æ‰€ä»¥è®¾ç½®ä¸º true, å¿½ç•¥åˆå§‹åŒ–äº‹ä»¶
 */
chokidar
  .watch(cwd, {
    ignoreInitial: true
  })
  .on('add', filePath => {
    const { name, ext } = path.parse(filePath)
    if (isNaN(+name)) {
      fs.rename(filePath, path.join(cwd, `${len.toString().padStart(3, 0)}${ext}`), err => {
        if (!err) {
          len++
        }
      })
    }
  })
```

è¿™é‡Œåªæ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­, å…·ä½“å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ›´æ”¹

## npm åŒ…

ä¹Ÿå¯ä»¥ç”Ÿæˆä¸€ä¸ªè‡ªåŠ¨é‡å‘½åçš„ `npm` åŒ…:

```js
#!/usr/bin/env node

const path = require('path')
const fs = require('fs')
const chokidar = require('chokidar')
const process = require('process')

const cwd = process.cwd()
const readDir = fs.readdirSync(cwd)
let len = readDir.length

chokidar.watch(cwd, { ignoreInitial: true }).on('add', filePath => {
  const { name, ext } = path.parse(filePath)
  if (isNaN(+name)) {
    fs.rename(filePath, path.join(cwd, `${len.toString().padStart(3, 0)}${ext}`), err => {
      if (!err) {
        len++
      }
    })
  }
})
```

å½“ç„¶è¿™åªé€‚ç”¨æ–‡ä»¶å¤¹ä¸‹å‡æ˜¯é€’å¢çš„æ–‡ä»¶, ç”±äºæ˜¯è‡ªç”¨, å°±ä¸åšè¿‡å¤šåˆ¤æ–­äº†, å¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±éœ€æ±‚æ›´æ”¹

## æ‰©å±•: é¡¹ç›®æ–°å»ºæ–‡ä»¶è‡ªåŠ¨åˆå§‹åŒ–é»˜è®¤å†…å®¹

åœ¨å¼€å‘æ–°åŠŸèƒ½æ—¶, æˆ‘ä»¬æ€»è¦ç»å†ä»¥ä¸‹æ­¥éª¤:

1. æ–°å»ºæ–‡ä»¶
2. åˆå§‹åŒ–é»˜è®¤å†…å®¹, åŒ…æ‹¬å¼•å…¥å¿…é¡»çš„ä¾èµ–å’Œä¸€äº›é»˜è®¤é…ç½®
3. å¯èƒ½è¿˜éœ€è¦åˆ›å»ºä¸€äº›å¯¹åº”çš„æ–‡ä»¶, æ¯”å¦‚æ–°å»º `.tsx` æ–‡ä»¶å, å¯¹åº”çš„è¦æ–°å»º `.scss` æ–‡ä»¶

è¿™äº›é»˜è®¤å†…å®¹æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `vscode` çš„ä»£ç æ¨¡ç‰ˆç”Ÿæˆ, ä½†æ¨¡ç‰ˆå±€é™æ€§è¿˜æ˜¯å¾ˆå¤§çš„, æ¯”å¦‚å¹¶ä¸èƒ½æ™ºèƒ½ä¿®æ”¹å¼•ç”¨è·¯å¾„, ä¸€äº›åç§°ä¸èƒ½åŠ¨æ€è®¾ç½®

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `chokidar` ç›‘å¬æ–‡ä»¶å¹¶å®Œæˆè¿™ä¸€ç³»åˆ—æ“ä½œ, æé«˜å·¥ä½œæ•ˆç‡

ç›®å½•æ ‘:

```
autorename/
â””â”€ src/
   â”œâ”€ pages/
   â”‚  â””â”€ Admin/
   â”œâ”€ store/
   â”‚  â””â”€ index.js
   â””â”€ index.js // å¤„ç†æ–°å¢æ–‡ä»¶
```

æ¯”å¦‚ä¸€ä¸ª `tsx` æ–‡ä»¶é»˜è®¤å†…å®¹ä¸º:

```tsx
import React, { useEffect } from 'react'
import { useImmer } from 'use-immer'
import { useStore } from '../../store'
import 'template.scss'

const template = function() {
  const globalStore = useStore()
  const id = globalStore.id

  // const [state, updateState] = useImmer<>({})

  useEffect(() => {})
  return <div></div>
}

export default template
```

è¿™é‡Œæœ‰å‡ ä¸ªåœ°æ–¹éœ€è¦å¤„ç†: `template` éœ€è¦ä¿®æ”¹æˆæ–‡ä»¶å, å¼•ç”¨è·¯å¾„éœ€è¦æ­£ç¡®, éœ€è¦æ–°å¢åŒåçš„ `scss` æ–‡ä»¶

### å®ç°é»˜è®¤å†…å®¹

æˆ‘ä»¬å…ˆæ¥å®ç°å½“å‰åŠŸèƒ½:

```js
const path = require('path')
const fs = require('fs')
const chokidar = require('chokidar')

chokidar
  .watch('./src', {
    ignoreInitial: true
  })
  .on('add', filePath => {
    const { ext } = path.parse(filePath)
    if (ext === '.tsx') {
      fs.writeFileSync(
        filePath,
        `import React, { useEffect } from 'react';
import { useImmer } from 'use-immer';
import { useStore } from '../../store';
import 'template.scss'

const template = function () {
  const globalStore = useStore();
  const id = globalStore.id;

  // const [state, updateState] = useImmer<>({})

  useEffect(() => {})
  return <div></div>;
};

export default template;
`
      )
    }
  })
```

### å®ç°åŸºæœ¬åŠŸèƒ½

`template` éœ€è¦ä¿®æ”¹æˆæ–‡ä»¶å, å¼•ç”¨è·¯å¾„éœ€è¦æ­£ç¡®, éœ€è¦æ–°å¢åŒåçš„ `scss` æ–‡ä»¶:

```js
const path = require('path')
const fs = require('fs')
const chokidar = require('chokidar')

const storeAbsolute = path.join(__dirname, 'store')

chokidar
  .watch('.', {
    ignoreInitial: true
  })
  .on('add', filePath => {
    const { dir, name, ext } = path.parse(filePath)
    if (ext === '.tsx') {
      let content = `import React, { useEffect } from 'react';
import { useImmer } from 'use-immer';
`
      // è·å–å½“å‰æ–‡ä»¶ç›®å½•(dir) åˆ° store ç›®å½•(storeAbsolute) çš„ç›¸å¯¹è·¯å¾„
      const storeRelative = path.relative(dir, storeAbsolute)
      content += `import { useStore } from '${storeRelative}';
import '${name}.scss'

const ${name} = function () {
  const globalStore = useStore();
  const id = globalStore.Info.id;

  // const [state, updateState] = useImmer<>({})

  useEffect(() => {})
  return <div></div>;
};

export default ${name};
`
      fs.writeFileSync(filePath, content)
      const scssName = path.join(dir, `${name}.scss`)
      if (!fs.existsSync(scssName)) {
        // æ–°å¢åŒåçš„ `scss` æ–‡ä»¶, è¿™é‡Œå¦‚æœæœ‰é»˜è®¤å†…å®¹ä¹Ÿå¯ä»¥ç»§ç»­å¤„ç†
        fs.writeFileSync(scssName, '')
      }
    }
  })
```

### æ–°å¢ `index` æ–‡ä»¶å’Œæ–°å¢æ–‡ä»¶å¤¹åŠŸèƒ½

æ–°å¢ `index.tsx` æ–‡ä»¶å¤„ç†é€»è¾‘:

å¦‚æœæ–°å¢çš„æ˜¯ `index.tsx` æ–‡ä»¶, é‚£ä¹ˆ `tsx` æ–‡ä»¶ä¸­ `name` å°±ä¸èƒ½æ˜¯ `index`, è€Œæ˜¯æ–‡ä»¶å¤¹åç§°, æ‰€ä»¥éœ€è¦åˆ¤æ–­ä¸€ä¸‹

```js
const path = require('path')
const fs = require('fs')
const chokidar = require('chokidar')

const storeAbsolute = path.join(__dirname, 'store')

chokidar
  .watch('.', {
    ignoreInitial: true
  })
  .on('add', filePath => {
    const { dir, name, ext } = path.parse(filePath)
    let exportName = name
    if (ext === '.tsx') {
      let content = `import React, { useEffect } from 'react';
import { useImmer } from 'use-immer';
`
      if (name === 'index') {
        // è·å–æ–°å¢æ–‡ä»¶çš„æ–‡ä»¶å¤¹åç§°
        exportName = path.basename(dir)
      }
      // è·å–å½“å‰æ–‡ä»¶ç›®å½•(dir) åˆ° store ç›®å½•(storeAbsolute) çš„ç›¸å¯¹è·¯å¾„
      const storeRelative = path.relative(dir, storeAbsolute)
      content += `import { useStore } from '${storeRelative}';
import '${name}.scss'

const ${exportName} = function () {
  const globalStore = useStore();
  const id = globalStore.Info.id;

  // const [state, updateState] = useImmer<>({})

  useEffect(() => {})
  return <div></div>;
};

export default ${exportName};
`
      fs.writeFileSync(filePath, content)
      const scssName = path.join(dir, `${name}.scss`)
      if (!fs.existsSync(scssName)) {
        fs.writeFileSync(scssName, '')
      }
    }
  })
```

è¿™æ ·å°±å¤„ç†å®Œæ–°å¢ `.tsx` æ–‡ä»¶çš„é€»è¾‘å•¦, ç°åœ¨å¤„ç†ä¸€ä¸‹æ–°å¢æ–‡ä»¶å¤¹çš„é€»è¾‘

ç”±äº `chokidar` æ”¯æŒé“¾å¼è°ƒç”¨, æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç»§ç»­å¢åŠ ç›‘å¬æ–‡ä»¶å¤¹çš„é€»è¾‘:

```js
  .on('addDir', dir => {
    const name = 'index'
    const storeRelative = path.relative(dir, storeAbsolute)
    const exportName = path.basename(dir)
    const content = `import React, { useEffect } from 'react';
import { useImmer } from 'use-immer';
import { useStore } from '${storeRelative}';
import '${name}.scss'

const ${exportName} = function () {
  const globalStore = useStore();
  const id = globalStore.Info.id;

  // const [state, updateState] = useImmer<>({})

  useEffect(() => {})
  return <div></div>;
};

export default ${exportName};`
    fs.writeFileSync(path.join(dir, 'index.tsx'), content)
    fs.writeFileSync(path.join(dir, 'index.scss'), '')
  })
```

è¿™é‡Œé»˜è®¤æ–°å»ºçš„æ–‡ä»¶éƒ½ä¸º `index`, è¿™æ ·å¼•å…¥çš„æ—¶å€™å¯ä»¥å°‘å†™ä¸€å±‚è·¯å¾„, å¯ä»¥ä¾æ®è‡ªå·±éœ€æ±‚æ›´æ”¹

ç”±äºç›‘å¬æ–‡ä»¶å’Œæ–‡ä»¶å¤¹é‡Œé¢å¤„ç†é€»è¾‘ç±»ä¼¼, æˆ‘ä»¬å¯ä»¥æå–å‡ºæ¥:

```js
const path = require('path')
const fs = require('fs')
const chokidar = require('chokidar')

const storeAbsolute = path.join(__dirname, 'store')

chokidar
  .watch('.', {
    ignoreInitial: true
  })
  .on('add', filePath => {
    const { dir, name, ext } = path.parse(filePath)
    handleFile(dir, name, ext)
  })
  .on('addDir', dir => {
    handleFile(dir, 'index', '.tsx')
  })

const handleFile = (dir, name, ext) => {
  let exportName = name
  if (ext === '.tsx') {
    let content = `import React, { useEffect } from 'react';
import { useImmer } from 'use-immer';
`
    if (name === 'index') {
      exportName = path.basename(dir)
    }
    // è·å–å½“å‰æ–‡ä»¶ç›®å½•(dir) åˆ° store ç›®å½•(storeAbsolute) çš„ç›¸å¯¹è·¯å¾„
    const storeRelative = path.relative(dir, storeAbsolute)
    content += `import { useStore } from '${storeRelative}';
import '${name}.scss'

const ${exportName} = function () {
  const globalStore = useStore();
  const id = globalStore.Info.id;

  // const [state, updateState] = useImmer<>({})

  useEffect(() => {})
  return <div></div>;
};

export default ${exportName};
`
    fs.writeFileSync(path.join(dir, `${name}${ext}`), content)
    const scssName = path.join(dir, `${name}.scss`)
    if (!fs.existsSync(scssName)) {
      fs.writeFileSync(scssName, '')
    }
  }
}
```

è‡³æ­¤æ–°å¢é€»è¾‘éƒ½å¤„ç†å®Œäº†, ç”±äºæ¯ä¸ªé¡¹ç›®å‡ä¸ç›¸åŒ, æ‰€ä»¥é‡Œé¢å¤„ç†é€»è¾‘ä¹Ÿä¸åŒ, è¿™é‡Œåªæä¾›ä¸€ä¸ªæ€è·¯

ä¼˜åŒ–ç‚¹ä¹Ÿæœ‰å¾ˆå¤š, æ¯”å¦‚è¿™é‡Œåªæœ‰ä¸€ä¸ªæ¨¡æ¿, å®é™…é¡¹ç›®ä¸­å¯èƒ½æœ‰å¤šä¸ªæ¨¡æ¿, è¿™æ ·å¯èƒ½éœ€è¦æ ¹æ®æ–°å»ºåç§°ä¸­çš„å…³é”®å­—æ¥åŠ è½½ä¸åŒçš„æ¨¡æ¿

### ä¸é¡¹ç›®ç»“åˆ

ä¸€å¼€å§‹æƒ³çš„æ˜¯å°†è¿™ä¸ªå’¨è¯¢å‘½ä»¤åˆå¹¶åˆ°å¯åŠ¨é¡¹ç›®çš„å‘½ä»¤ä¸­, è¿™æ ·å¯åŠ¨é¡¹ç›®çš„åŒæ—¶å°±å¯åŠ¨æˆ‘ä»¬è¿™ä¸ªç›‘å¬å¤„ç†äº†, ä¸ç”¨å¯åŠ¨å¤šä¸ªæœåŠ¡

- [npm å¹¶è¡Œ&ä¸²è¡Œæ‰§è¡Œå¤šä¸ª scripts å‘½ä»¤ - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/137993627)

```json
{
  "scripts": {
    "start": "node ./watch.js & react-app-rewired start"
  }
}
```

ä½†å®é™…æµ‹è¯•å‘ç°ä¸è¡Œ, å¯ä»¥æ­£å¸¸ç›‘å¬æ–‡ä»¶, ä½†ä¸èƒ½å¯åŠ¨é¡¹ç›®, åº”è¯¥æ˜¯ `&` å‘½ä»¤æ˜¯åœ¨å‰ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œå®Œå†æ‰§è¡Œåä¸€ä¸ªå‘½ä»¤, ä½† `watch` æ˜¯ä¸€ç›´ç›‘å¬, ä¸ä¼šæ‰§è¡Œå®Œ, æ‰€ä»¥ä¸ä¼šå¯åŠ¨é¡¹ç›®

é‚£å°±å†™ä¸€ä¸ªæ’ä»¶, é€šè¿‡ `webpack` ä¸€èµ·å¯åŠ¨

å®é™…æµ‹è¯• `Vue` çš„ `vue.config.js` æ˜¯å¯è¡Œçš„:

```js
const chokidar = require('chokidar')
class WatchFile {
  apply() {
    chokidar.watch('./src', { ignoreInitial: true }).on('all', (event, path) => {
      console.log(event, path)
    })
  }
}

module.exports = {
  configureWebpack: {
    // ...
    plugins: [new WatchFile()]
  }
}
```

è€Œåœ¨ `React` ä¸­çš„ `config-overrides.js` ä¸­å´æ²¡æœ‰ç”Ÿæ•ˆ, å¯èƒ½æ˜¯è‡ªå·±å†™çš„ä½ç½®ä¸å¯¹

ç›®å‰çš„åšæ³•æ˜¯ç›´æ¥å†™åœ¨äº† `config-overrides.js` ä¸­:

```js
const chokidar = require('chokidar')
chokidar.watch('./src', { ignoreInitial: true }).on('all', (event, path) => {
  console.log(event, path)
})

// ...
```

è¿™æ ·, å°†ä¸Šé¢çš„å¤„ç†é€»è¾‘åŠ è¿›æ¥å°±å¯ä»¥äº†
